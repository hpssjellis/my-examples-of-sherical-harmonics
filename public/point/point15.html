<!DOCTYPE html>
<html lang="en">
Â  <head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  Â  <title>Waterball Perturbations Point Cloud</title>
Â  Â  <style>
Â  Â  Â  /* Basic reset and full-page layout for the canvas */
Â  Â  Â  body, html {
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  overscroll-behavior: none;
Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  background-color: #f0f0f0;
Â  Â  Â  Â  font-family: sans-serif;
Â  Â  Â  }

Â  Â  Â  /* Canvas styling to fill the available space */
Â  Â  Â  canvas {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  display: block;
Â  Â  Â  }

Â  Â  Â  /* Styling for UI containers */
Â  Â  Â  #myUiContainer, #myNumberContainer, #mySaveLoadContainer, #howto-container, #debug-info {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  background-color: rgba(255, 255, 255, 0.85);
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  line-height: 1.5;
Â  Â  Â  Â  z-index: 10;
Â  Â  Â  }

Â  Â  Â  #myUiContainer {
Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  left: 20px;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  width: 250px;
Â  Â  Â  Â  max-height: calc(100% - 40px);
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  }

Â  Â  Â  #myNumberContainer {
Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  right: 20px;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  #mySaveLoadContainer {
Â  Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  Â  left: 20px;
Â  Â  Â  Â  Â  width: 300px;
Â  Â  Â  }

Â  Â  Â  #howto-container {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  left: auto;
Â  Â  Â  Â  width: 200px;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  /* Simple button and textarea styling */
Â  Â  Â  .my-button {
Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  margin: 5px 5px 5px 0;
Â  Â  Â  Â  Â  background-color: #007bff;
Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  }
Â  Â  Â  .my-button:hover {
Â  Â  Â  Â  Â  background-color: #0056b3;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  #myPointDataTextarea {
Â  Â  Â  Â  Â  width: 95%;
Â  Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  resize: vertical;
Â  Â  Â  Â  Â  font-family: monospace;
Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  }

Â  Â  Â  /* File Input Styling */
Â  Â  Â  #myFileLoader {
Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  Â  background-color: #f7f7f7;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  label {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  }

Â  Â  Â  .slider-group {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  border: 1px solid #eee;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  background-color: rgba(240, 240, 240, 0.5);
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  input[type="range"] { width: 100%; }

Â  Â  Â  .slider-value {
Â  Â  Â  Â  align-self: flex-end;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  }
Â  Â  Â  
Â  Â  </style>
Â  Â  Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
Â  Â  Â  Â  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
Â  Â  Â  Â  Â  Â  Â  Â  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
Â  Â  Â  Â  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/GLTFExporter.js"></script>
Â  Â  Â  Â  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/BufferGeometryUtils.js"></script> 
Â  </head>
Â  <body>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="myUiContainer">
Â  Â  Â  <div style="display: flex; flex-direction: column; gap: 5px;">
Â  Â  Â  Â  <label>
Â  Â  Â  Â  Â  <input type="checkbox" id="myAutoRotateCheckbox" checked 
Â  Â  Â  Â  Â  Â  Â  Â  Â onclick="mySetAutoRotate(this.checked)"> Auto rotate
Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="my-button" onclick="myResetPerturbations()" style="background-color: #dc3545;">
Â  Â  Â  Â  Â  Reset Perturbations to Zero
Â  Â  Â  Â  </button>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="slider-group" style="margin-top: 5px;">
Â  Â  Â  Â  <label for="my-point-size-slider">Point Size:</label>
Â  Â  Â  Â  <input type="range" id="my-point-size-slider" min="0.5" max="5" value="2" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdatePointSize(event)"/>
Â  Â  Â  Â  <span id="my-point-size-value" class="slider-value">2.0</span>
Â  Â  Â  </div>

Â  Â  Â  <h3>Wave 1 Parameters</h3>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave1-amplitude-slider">Amplitude (Wave 1):</label>
Â  Â  Â  Â  <input type="range" id="wave1-amplitude-slider" min="0" max="10" value="2" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave1Amplitude(event)"/>
Â  Â  Â  Â  <span id="wave1-amplitude-value" class="slider-value">2.0</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave1-freq-theta-slider">Freq Theta (Wave 1):</label>
Â  Â  Â  Â  <input type="range" id="wave1-freq-theta-slider" min="0" max="10" value="4" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave1FreqTheta(event)"/>
Â  Â  Â  Â  <span id="wave1-freq-theta-value" class="slider-value">4.0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave1-freq-phi-slider">Freq Phi (Wave 1):</label>
Â  Â  Â  Â  <input type="range" id="wave1-freq-phi-slider" min="0" max="10" value="6" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave1FreqPhi(event)"/>
Â  Â  Â  Â  <span id="wave1-freq-phi-value" class="slider-value">6.0</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave1-speed-slider">Speed (Wave 1):</label>
Â  Â  Â  Â  <input type="range" id="wave1-speed-slider" min="-2" max="2" value="0.5" step="0.05" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave1Speed(event)"/>
Â  Â  Â  Â  <span id="wave1-speed-value" class="slider-value">0.50</span>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  <h3>Wave 2 Parameters</h3>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave2-amplitude-slider">Amplitude (Wave 2):</label>
Â  Â  Â  Â  <input type="range" id="wave2-amplitude-slider" min="0" max="10" value="2" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave2Amplitude(event)"/>
Â  Â  Â  Â  <span id="wave2-amplitude-value" class="slider-value">2.0</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave2-freq-theta-slider">Freq Theta (Wave 2):</label>
Â  Â  Â  Â  <input type="range" id="wave2-freq-theta-slider" min="0" max="10" value="7" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave2FreqTheta(event)"/>
Â  Â  Â  Â  <span id="wave2-freq-theta-value" class="slider-value">7.0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave2-freq-phi-slider">Freq Phi (Wave 2):</label>
Â  Â  Â  Â  <input type="range" id="wave2-freq-phi-slider" min="0" max="10" value="3" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave2FreqPhi(event)"/>
Â  Â  Â  Â  <span id="wave2-freq-phi-value" class="slider-value">3.0</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave2-speed-slider">Speed (Wave 2):</label>
Â  Â  Â  Â  <input type="range" id="wave2-speed-slider" min="-2" max="2" value="0.8" step="0.05" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave2Speed(event)"/>
Â  Â  Â  Â  <span id="wave2-speed-value" class="slider-value">0.80</span>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  <h3>Wave 3 Parameters</h3>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave3-amplitude-slider">Amplitude (Wave 3):</label>
Â  Â  Â  Â  <input type="range" id="wave3-amplitude-slider" min="0" max="10" value="1.5" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave3Amplitude(event)"/>
Â  Â  Â  Â  <span id="wave3-amplitude-value" class="slider-value">1.5</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave3-freq-theta-slider">Freq Theta (Wave 3):</label>
Â  Â  Â  Â  <input type="range" id="wave3-freq-theta-slider" min="0" max="10" value="5" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave3FreqTheta(event)"/>
Â  Â  Â  Â  <span id="wave3-freq-theta-value" class="slider-value">5.0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave3-freq-phi-slider">Freq Phi (Wave 3):</label>
Â  Â  Â  Â  <input type="range" id="wave3-freq-phi-slider" min="0" max="10" value="8" step="0.1" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave3FreqPhi(event)"/>
Â  Â  Â  Â  <span id="wave3-freq-phi-value" class="slider-value">8.0</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="slider-group">
Â  Â  Â  Â  <label for="wave3-speed-slider">Speed (Wave 3):</label>
Â  Â  Â  Â  <input type="range" id="wave3-speed-slider" min="-2" max="2" value="-0.6" step="0.05" 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="myUpdateWave3Speed(event)"/>
Â  Â  Â  Â  <span id="wave3-speed-value" class="slider-value">-0.60</span>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div id="myNumberContainer">
Â  Â  Â  <b>Sphere Resolution</b>
Â  Â  Â  <form id="myResolutionForm" onchange="myHandleResolutionChange(event)">
Â  Â  Â  Â  <label><input type="radio" name="myOptions" value="0"> Low (<span id="myLowResValue"></span> vertices)</label><br>
Â  Â  Â  Â  <label><input type="radio" name="myOptions" value="1" checked> Medium (<span id="myMediumResValue"></span> vertices)</label><br>
Â  Â  Â  Â  <label><input type="radio" name="myOptions" value="2"> High (<span id="myHighResValue"></span> vertices)</label><br>
Â  Â  Â  </form>
Â  Â  </div>
Â  Â  
Â  Â  Â  Â  <div id="mySaveLoadContainer">
Â  Â  Â  Â  <b>Point Cloud Data (JSON)</b>
Â  Â  Â  Â  <div style="margin-top: 5px;">
Â  Â  Â  Â  Â  Â  <button class="my-button" onclick="mySaveToTextarea()">Save to Textarea</button>
Â  Â  Â  Â  Â  Â  <button class="my-button" onclick="myLoadFromTextarea()">Load from Textarea</button>
Â  Â  Â  Â  Â  Â  <button class="my-button" onclick="mySaveToFile()">Download JSON File</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <textarea id="myPointDataTextarea" placeholder="Paste JSON point data here to load..."></textarea>
Â  Â  Â  Â  <div id="myStatusMessage" style="color: #007bff; font-weight: bold; margin-top: 5px;"></div>
Â  Â  Â  Â  
Â  Â  Â  Â  <hr style="border: 0; height: 1px; background-color: #ccc; margin: 10px 0;">
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="myFileLoader">
Â  Â  Â  Â  Â  Â  Â Load from JSON File:
Â  Â  Â  Â  Â  Â  Â <input type="file" accept=".json" onchange="myLoadFromFile(event)" style="display: block; margin-top: 5px;">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <hr style="border: 0; height: 1px; background-color: #007bff; margin: 10px 0;">
Â  Â  Â  Â  
Â  Â  Â  Â  <b>Blender (.glb) Import/Export</b>
Â  Â  Â  Â  <div style="margin-top: 5px;">
Â  Â  Â  Â  Â  Â  <button class="my-button" onclick="myExportPointCloud()">Export to .glb</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="myGltfFileLoader">
Â  Â  Â  Â  Â  Â  Load Mesh from .glb File:
Â  Â  Â  Â  Â  Â  <input type="file" accept=".glb, .gltf" onchange="myLoadFromGltfFile(event)" style="display: block; margin-top: 5px;">
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="howto-container">
Â  Â  Â  <div> <b>Drag</b> to move camera </div>
Â  Â  Â  <div> <b>Scroll</b> to zoom in and out </div>
Â  Â  Â  <div> <b>Mouseover</b> to highlight points </div>
Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="debug-info">
Â  Â  Â  <span id="error-reason">Loading 3D scene...</span>
Â  Â  </div>
Â  Â  
Â  Â  Â  Â  <canvas id="myFluidCanvas"></canvas>

Â  Â  <script>
Â  Â  Â  // Declare Three.js global variables
Â  Â  Â  let scene, camera, renderer, myPointCloud, controls, myOriginalPositions;
Â  Â  Â  let mySphereMesh;Â 
Â  Â  Â  
Â  Â  Â  // --- MOUSE INTERACTION (RAYCASTING) VARIABLES ---
Â  Â  Â  let myRaycaster;
Â  Â  Â  let myMousePosition = new THREE.Vector2();
Â  Â  Â  let myHighlightedPoint = null;
Â  Â  Â  // ------------------------------------

Â  Â  Â  // Perturbation parameters (Global, matching initial slider values)
Â  Â  Â  let wave1_amplitude = 2.0;
Â  Â  Â  let wave1_freq_theta = 4.0;
Â  Â  Â  let wave1_freq_phi = 6.0;
Â  Â  Â  let wave1_speed = 0.5;
Â  Â  Â  
Â  Â  Â  let wave2_amplitude = 2.0;
Â  Â  Â  let wave2_freq_theta = 7.0;
Â  Â  Â  let wave2_freq_phi = 3.0;
Â  Â  Â  let wave2_speed = 0.8;
Â  Â  Â  
Â  Â  Â  let wave3_amplitude = 1.5;
Â  Â  Â  let wave3_freq_theta = 5.0;
Â  Â  Â  let wave3_freq_phi = 8.0;
Â  Â  Â  let wave3_speed = -0.6;
      let wave3_freq_phi = 8.0;
      let wave3_speed = -0.6;

Â  Â  Â  // Sphere segment configurations for different resolutions
Â  Â  Â  let segments = {
Â  Â  Â  Â  Â  low: { width: 16, height: 16 },
Â  Â  Â  Â  Â  medium: { width: 32, height: 32 },
Â  Â  Â  Â  Â  high: { width: 64, height: 64 }
Â  Â  Â  };
Â  Â  Â  let myCurrentSegments = segments.medium; // Default resolution
Â  Â  Â  const myInitialSphereRadius = 50; // Base radius of the sphere
Â  Â  Â  
Â  Â  Â  // DOM Elements
Â  Â  Â  const myDebugInfo = document.getElementById('debug-info');Â 
Â  Â  Â  const myPointDataTextarea = document.getElementById('myPointDataTextarea');
Â  Â  Â  const myStatusMessage = document.getElementById('myStatusMessage');


Â  Â  Â  /**
Â  Â  Â  Â * Calculates the total number of vertices.
Â  Â  Â  Â */
Â  Â  Â  function myGetVertexCount(myWidthSegments, myHeightSegments) {
Â  Â  Â  Â  Â  return (myWidthSegments + 1) * (myHeightSegments + 1);
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  // Populate vertex counts in the UI labels (renamed IDs)
Â  Â  Â  document.getElementById('myLowResValue').textContent = myGetVertexCount(segments.low.width, segments.low.height);
Â  Â  Â  document.getElementById('myMediumResValue').textContent = myGetVertexCount(segments.medium.width, segments.medium.height);
Â  Â  Â  document.getElementById('myHighResValue').textContent = myGetVertexCount(segments.high.width, segments.high.height);

Â  Â  Â  /**
Â  Â  Â  Â * Initializes the Three.js scene.Â 
Â  Â  Â  Â */
Â  Â  Â  function myInit() {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Show loading messageÂ 
Â  Â  Â  Â  Â  Â  Â  myDebugInfo.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  myDebugInfo.querySelector('span').textContent = 'Initializing 3D scene...';

Â  Â  Â  Â  Â  Â  Â  const myCanvas = document.getElementById('myFluidCanvas');
Â  Â  Â  Â  Â  Â  Â  renderer = new THREE.WebGLRenderer({ canvas: myCanvas, antialias: true });Â 
Â  Â  Â  Â  Â  Â  Â  renderer.setSize(window.innerWidth, window.innerHeight);Â 
Â  Â  Â  Â  Â  Â  Â  renderer.setPixelRatio(window.devicePixelRatio);Â 

Â  Â  Â  Â  Â  Â  Â  // Scene setup
Â  Â  Â  Â  Â  Â  Â  scene = new THREE.Scene();
Â  Â  Â  Â  Â  Â  Â  scene.background = new THREE.Color(0xf0f0f0);
Â  Â  Â  Â  Â  Â  Â  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
Â  Â  Â  Â  Â  Â  Â  camera.position.z = 150;
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // Lights
Â  Â  Â  Â  Â  Â  Â  scene.add(new THREE.AmbientLight(0x404040, 2));
Â  Â  Â  Â  Â  Â  Â  const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
Â  Â  Â  Â  Â  Â  Â  directionalLight.position.set(1, 1, 1).normalize();
Â  Â  Â  Â  Â  Â  Â  scene.add(directionalLight);

Â  Â  Â  Â  Â  Â  Â  // Create the initial point cloud
Â  Â  Â  Â  Â  Â  Â  myCreatePointCloud(myCurrentSegments.width, myCurrentSegments.height);

Â  Â  Â  Â  Â  Â  Â  // OrbitControls: Allows user to interactively move/zoom the camera
Â  Â  Â  Â  Â  Â  Â  controls = new THREE.OrbitControls(camera, renderer.domElement);
Â  Â  Â  Â  Â  Â  Â  controls.autoRotate = document.getElementById('myAutoRotateCheckbox').checked;
Â  Â  Â  Â  Â  Â  Â  controls.autoRotateSpeed = 1.0;
Â  Â  Â  Â  Â  Â  Â  controls.enableDamping = true;
Â  Â  Â  Â  Â  Â  Â  controls.dampingFactor = 0.05;
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // Initialize Raycaster for mouse interaction
Â  Â  Â  Â  Â  Â  Â  myRaycaster = new THREE.Raycaster();
Â  Â  Â  Â  Â  Â  Â  // Adjust threshold for easier selection of points
Â  Â  Â  Â  Â  Â  Â  myRaycaster.params.Points.threshold = 1;

Â  Â  Â  Â  Â  Â  Â  // Event Listener for Mouse Movement (captures coordinates)
Â  Â  Â  Â  Â  Â  Â  window.addEventListener('mousemove', (myEvent) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Calculate mouse position in normalized device coordinates (-1 to +1)
Â  Â  Â  Â  Â  Â  Â  Â  Â  myMousePosition.x = (myEvent.clientX / window.innerWidth) * 2 - 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  myMousePosition.y = -(myEvent.clientY / window.innerHeight) * 2 + 1;
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  // Event Listener
Â  Â  Â  Â  Â  Â  Â  window.onresize = myOnWindowResize;

Â  Â  Â  Â  Â  Â  Â  myDebugInfo.style.display = 'none'; // Hide debug info once loaded successfully
Â  Â  Â  Â  Â  Â  Â  myAnimate();
Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  console.error("Error during initialization:", error);
Â  Â  Â  Â  Â  Â  Â  // Display error messageÂ 
Â  Â  Â  Â  Â  Â  Â  myDebugInfo.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  myDebugInfo.querySelector('span').textContent = `Error: ${error.message}. Please refresh the page.`;
Â  Â  Â  Â  Â  }
Â  Â  Â  }


          // NEW: Function to force all slider labels to display the current global variable values
    function myInitializeSliderValues() {
        // Point Size
        const myPointSize = parseFloat(document.getElementById('my-point-size-slider')?.value || 2.0);
        document.getElementById('my-point-size-value').textContent = myPointSize.toFixed(1);
        
        // Wave 1
        document.getElementById('wave1-amplitude-value').textContent = wave1_amplitude.toFixed(1);
        document.getElementById('wave1-freq-theta-value').textContent = wave1_freq_theta.toFixed(1);
        document.getElementById('wave1-freq-phi-value').textContent = wave1_freq_phi.toFixed(1);
        document.getElementById('wave1-speed-value').textContent = wave1_speed.toFixed(2);

        // Wave 2
        document.getElementById('wave2-amplitude-value').textContent = wave2_amplitude.toFixed(1);
        document.getElementById('wave2-freq-theta-value').textContent = wave2_freq_theta.toFixed(1);
        document.getElementById('wave2-freq-phi-value').textContent = wave2_freq_phi.toFixed(1);
        document.getElementById('wave2-speed-value').textContent = wave2_speed.toFixed(2);

        // Wave 3
        document.getElementById('wave3-amplitude-value').textContent = wave3_amplitude.toFixed(1);
        document.getElementById('wave3-freq-theta-value').textContent = wave3_freq_theta.toFixed(1);
        document.getElementById('wave3-freq-phi-value').textContent = wave3_freq_phi.toFixed(1);
        document.getElementById('wave3-speed-value').textContent = wave3_speed.toFixed(2);
    }

Â  Â  Â  /**
Â  Â  Â  Â * Creates or recreates the point cloud object.Â 
Â  Â  Â  Â */
Â  Â  Â  function myCreatePointCloud(myWidthSegments, myHeightSegments) {
Â  Â  Â  Â  Â  // Dispose of old objects
Â  Â  Â  Â  Â  if (mySphereMesh) {
Â  Â  Â  Â  Â  Â  Â  scene.remove(mySphereMesh);
Â  Â  Â  Â  Â  Â  Â  mySphereMesh.geometry.dispose();
Â  Â  Â  Â  Â  Â  Â  mySphereMesh.material.dispose();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (myPointCloud) {
Â  Â  Â  Â  Â  Â  Â  scene.remove(myPointCloud);
Â  Â  Â  Â  Â  Â  Â  myPointCloud.geometry.dispose();
Â  Â  Â  Â  Â  Â  Â  myPointCloud.material.dispose();
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // Create Geometry
Â  Â  Â  Â  Â  const myGeometry = new THREE.SphereGeometry(myInitialSphereRadius, myWidthSegments, myHeightSegments);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // --- ADD VERTEX COLORS (REQUIRED FOR HIGHLIGHTING) ---
Â  Â  Â  Â  Â  const myColorArray = new Float32Array(myGeometry.attributes.position.count * 3);
Â  Â  Â  Â  Â  // Set all points to white initially
Â  Â  Â  Â  Â  for (let i = 0; i < myColorArray.length; i += 3) {
Â  Â  Â  Â  Â  Â  Â  myColorArray[i] = 1.0;Â  Â 
Â  Â  Â  Â  Â  Â  Â  myColorArray[i + 1] = 1.0;Â 
Â  Â  Â  Â  Â  Â  Â  myColorArray[i + 2] = 1.0;Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  myGeometry.setAttribute('color', new THREE.BufferAttribute(myColorArray, 3));


Â  Â  Â  Â  Â  // Create a transparent mesh for visual reference
Â  Â  Â  Â  Â  const myMeshMaterial = new THREE.MeshPhongMaterial({
Â  Â  Â  Â  Â  Â  Â  color: 0x007bff, transparent: true, opacity: 0.1, shininess: 100, specular: 0x333333
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  mySphereMesh = new THREE.Mesh(myGeometry, myMeshMaterial);
Â  Â  Â  Â  Â  scene.add(mySphereMesh);

Â  Â  Â  Â  Â  // Create Points (Point Cloud) - Use vertexColors: true
Â  Â  Â  Â  Â  const myPointSize = parseFloat(document.getElementById('my-point-size-slider')?.value || 2);
Â  Â  Â  Â  Â  const myPointsMaterial = new THREE.PointsMaterial({
Â  Â  Â  Â  Â  Â  Â  vertexColors: true, // IMPORTANT: Allows us to change point colors individually
Â  Â  Â  Â  Â  Â  Â  size: myPointSize,Â  // Use the current size from the slider
Â  Â  Â  Â  Â  Â  Â  sizeAttenuation: true
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  myPointCloud = new THREE.Points(myGeometry, myPointsMaterial);
Â  Â  Â  Â  Â  scene.add(myPointCloud);

Â  Â  Â  Â  Â  // Store original vertex positions
Â  Â  Â  Â  Â  myOriginalPositions = new Float32Array(myGeometry.attributes.position.array.length);
Â  Â  Â  Â  Â  myGeometry.attributes.position.array.forEach((myVal, myIndex) => {
Â  Â  Â  Â  Â  Â  Â  myOriginalPositions[myIndex] = myVal;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Reset highlighted point when resolution changes
Â  Â  Â  Â  Â  myHighlightedPoint = null;Â 
Â  Â  Â  Â  Â  myStatusMessage.textContent = `Created sphere with ${myGeometry.attributes.position.count} vertices.`;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  /**
Â  Â  Â  Â * Updates the point cloud's geometry positions with new data.
Â  Â  Â  Â */
Â  Â  Â  function myUpdatePointCloudPositions(myNewPositionsArray) {
Â  Â  Â  Â  Â  if (!myPointCloud) {
Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = 'Error: Point Cloud not initialized.';
Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const myGeometry = myPointCloud.geometry;
Â  Â  Â  Â  Â  const myPositionAttribute = myGeometry.attributes.position;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (myNewPositionsArray.length !== myPositionAttribute.array.length) {
Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = `Error: Position length mismatch. Expected ${myPositionAttribute.array.length}, got ${myNewPositionsArray.length}. Did you change resolution?`;
Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Set the new positions and signal Three.js to update
Â  Â  Â  Â  Â  myPositionAttribute.array.set(myNewPositionsArray);Â 
Â  Â  Â  Â  Â  myPositionAttribute.needsUpdate = true;
Â  Â  Â  Â  Â  mySphereMesh.geometry.attributes.position.needsUpdate = true;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  myStatusMessage.textContent = `Loaded ${myNewPositionsArray.length / 3} vertices successfully.`;
Â  Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  /**
Â  Â  Â  Â * Saves the current deformed point cloud data to the textarea.
Â  Â  Â  Â */
Â  Â  Â  function mySaveToTextarea() {
Â  Â  Â  Â  Â  if (!myPointCloud) return;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const myPositions = myPointCloud.geometry.attributes.position.array;
Â  Â  Â  Â  Â  // Convert Float32Array to standard Array for JSON
Â  Â  Â  Â  Â  const myPositionsArray = Array.from(myPositions);Â 
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const mySaveData = {
Â  Â  Â  Â  Â  Â  Â  metadata: "Three.js Deformed Point Cloud Positions (X, Y, Z coordinates)",
Â  Â  Â  Â  Â  Â  Â  vertexCount: myPositions.length / 3,
Â  Â  Â  Â  Â  Â  Â  segments: myCurrentSegments,
Â  Â  Â  Â  Â  Â  Â  positions: myPositionsArray
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  myPointDataTextarea.value = JSON.stringify(mySaveData, null, 2); // 2 spaces for formatting
Â  Â  Â  Â  Â  myStatusMessage.textContent = `Saved ${myPositions.length / 3} vertices to textarea.`;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  /**
Â  Â  Â  Â * Loads point cloud data from the textarea (the main processing logic).
Â  Â  Â  Â */
Â  Â  Â  function myLoadFromTextarea() {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const myJsonString = myPointDataTextarea.value.trim();
Â  Â  Â  Â  Â  Â  Â  if (!myJsonString) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = 'Error: Textarea is empty.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  const myLoadedData = JSON.parse(myJsonString);
Â  Â  Â  Â  Â  Â  Â  const myNewPositionsArray = myLoadedData.positions;
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(myNewPositionsArray)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = 'Error: Loaded data structure is invalid (missing positions array).';
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  myUpdatePointCloudPositions(myNewPositionsArray);
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  } catch (myError) {
Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = `Error loading data: ${myError.message}`;
Â  Â  Â  Â  Â  Â  Â  console.error(myError);
Â  Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  /**
Â  Â  Â  Â * Loads a JSON file selected by the user, then passes the data toÂ 
Â  Â  Â  Â * myLoadFromTextarea. (Uses async/await)
Â  Â  Â  Â */
Â  Â  Â  async function myLoadFromFile(myEvent) {
Â  Â  Â  Â  Â  const myFile = myEvent.target.files[0];
Â  Â  Â  Â  Â  if (!myFile) {
Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = 'No file selected.';
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  myStatusMessage.textContent = `Reading file: ${myFile.name}...`;

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  // Read the file content asynchronously
Â  Â  Â  Â  Â  Â  Â  const myFileText = await new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const myReader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  Â  myReader.onload = () => resolve(myReader.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  myReader.onerror = () => reject(new Error('Failed to read file.'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  myReader.readAsText(myFile);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // 1. Put the file content into the textarea for inspection
Â  Â  Â  Â  Â  Â  Â  myPointDataTextarea.value = myFileText;Â 
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // 2. Call the main processing function
Â  Â  Â  Â  Â  Â  Â  myLoadFromTextarea();Â 
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // Clear file input so the same file can be loaded again
Â  Â  Â  Â  Â  Â  Â  myEvent.target.value = '';Â 

Â  Â  Â  Â  Â  } catch (myError) {
Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = `Error reading file: ${myError.message}`;
Â  Â  Â  Â  Â  Â  Â  console.error(myError);
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  /**
Â  Â  Â  Â * Downloads the current point cloud data as a JSON file.
Â  Â  Â  Â */
Â  Â  Â  function mySaveToFile() {
Â  Â  Â  Â  Â  mySaveToTextarea(); // First, generate the data in the textarea
Â  Â  Â  Â  Â  const myJsonString = myPointDataTextarea.value;
Â  Â  Â  Â  Â  const myBlob = new Blob([myJsonString], { type: 'application/json' });
Â  Â  Â  Â  Â  const myUrl = URL.createObjectURL(myBlob);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Create a temporary link element for the download
Â  Â  Â  Â  Â  const myLink = document.createElement('a');
Â  Â  Â  Â  Â  myLink.href = myUrl;
Â  Â  Â  Â  Â  myLink.download = `pointcloud-${Date.now()}.json`;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Programmatically click the link to trigger download
Â  Â  Â  Â  Â  document.body.appendChild(myLink);
Â  Â  Â  Â  Â  myLink.click();
Â  Â  Â  Â  Â  document.body.removeChild(myLink);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  myStatusMessage.textContent = 'Point Cloud downloaded as JSON file.';
Â  Â  Â  Â  Â  URL.revokeObjectURL(myUrl); // Clean up
Â  Â  Â  }

Â  Â  Â  /**
Â  Â  Â  Â * Handles window resizing.Â 
Â  Â  Â  Â */
Â  Â  Â  function myOnWindowResize() {
Â  Â  Â  Â  Â  camera.aspect = window.innerWidth / window.innerHeight;
Â  Â  Â  Â  Â  camera.updateProjectionMatrix();
Â  Â  Â  Â  Â  renderer.setSize(window.innerWidth, window.innerHeight);
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  /**
Â  Â  Â  Â * Highlights a point by setting its color attribute.
Â  Â  Â  Â */
Â  Â  Â  function myHighlightPointColor(myIndex, myColorValue) {
Â  Â  Â  Â  Â  const myColors = myPointCloud.geometry.attributes.color;
Â  Â  Â  Â  Â  if (!myColors) return;

Â  Â  Â  Â  Â  const myColor = new THREE.Color(myColorValue);
Â  Â  Â  Â  Â  myColors.setXYZ(myIndex, myColor.r, myColor.g, myColor.b);
Â  Â  Â  Â  Â  myColors.needsUpdate = true;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  /**
Â  Â  Â  Â * Restores a point's color to the default white.
Â  Â  Â  Â */
Â  Â  Â  function myRestorePointColor(myIndex) {
Â  Â  Â  Â  Â  const myColors = myPointCloud.geometry.attributes.color;
Â  Â  Â  Â  Â  const myDefaultColor = new THREE.Color(0xffffff); // White
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  myColors.setXYZ(myIndex, myDefaultColor.r, myDefaultColor.g, myDefaultColor.b);
Â  Â  Â  Â  Â  myColors.needsUpdate = true;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  /**
Â  Â  Â  Â * Uses Raycasting to detect if the mouse is over a point and highlights it.
Â  Â  Â  Â */
Â  Â  Â  function myCheckIntersections() {
Â  Â  Â  Â  Â  if (!myPointCloud) return;

Â  Â  Â  Â  Â  // 1. Update the raycaster with the camera and mouse position
Â  Â  Â  Â  Â  myRaycaster.setFromCamera(myMousePosition, camera);

Â  Â  Â  Â  Â  // 2. Calculate intersections. Note: sizeAttenuation: true is required for this to work well.
Â  Â  Â  Â  Â  const myIntersects = myRaycaster.intersectObject(myPointCloud);

Â  Â  Â  Â  Â  // 3. Handle highlight
Â  Â  Â  Â  Â  if (myIntersects.length > 0) {
Â  Â  Â  Â  Â  Â  Â  // Intersects are sorted by distance, the first one is the closest
Â  Â  Â  Â  Â  Â  Â  const myIntersectedPoint = myIntersects[0].index;
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if (myHighlightedPoint !== myIntersectedPoint) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Restore color of previously highlighted point
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (myHighlightedPoint !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myRestorePointColor(myHighlightedPoint);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  // Highlight the new point (e.g., set color to red)
Â  Â  Â  Â  Â  Â  Â  Â  Â  myHighlightPointColor(myIntersectedPoint, 0xff0000); // Red
Â  Â  Â  Â  Â  Â  Â  Â  Â  myHighlightedPoint = myIntersectedPoint;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  // No intersection, restore previous point color
Â  Â  Â  Â  Â  Â  Â  if (myHighlightedPoint !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  myRestorePointColor(myHighlightedPoint);
Â  Â  Â  Â  Â  Â  Â  Â  Â  myHighlightedPoint = null;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  /**
Â  Â  Â  Â * The main animation loop.Â 
Â  Â  Â  Â */
Â  Â  Â  function myAnimate() {
Â  Â  Â  Â  Â  requestAnimationFrame(myAnimate);

Â  Â  Â  Â  Â  // Update point cloud perturbations
Â  Â  Â  Â  Â  myPerturbPointCloud(myPointCloud.geometry, myOriginalPositions, performance.now() * 0.001);

Â  Â  Â  Â  Â  // Check for mouse intersection (mouseover effect)
Â  Â  Â  Â  Â  myCheckIntersections();Â 

Â  Â  Â  Â  Â  // Inform Three.js that vertex positions have changed
Â  Â  Â  Â  Â  myPointCloud.geometry.attributes.position.needsUpdate = true;
Â  Â  Â  Â  Â  mySphereMesh.geometry.attributes.position.needsUpdate = true;Â 

Â  Â  Â  Â  Â  controls.update(); // Required for OrbitControls damping and auto-rotate
Â  Â  Â  Â  Â  renderer.render(scene, camera);
Â  Â  Â  }

Â  Â  Â  /**
Â  Â  Â  Â * Applies additive spherical sinusoidal perturbations.
Â  Â  Â  Â */
Â  Â  Â  function myPerturbPointCloud(myGeometry, myOriginalPos, myTime) {
Â  Â  Â  Â  Â  if (!myGeometry.attributes.position || !myOriginalPos) return; // Safety check
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const myPositionAttribute = myGeometry.attributes.position;
Â  Â  Â  Â  Â  const myNumVertices = myPositionAttribute.count;

Â  Â  Â  Â  Â  for (let i = 0; i < myNumVertices; i++) {
Â  Â  Â  Â  Â  Â  Â  const i3 = i * 3;

Â  Â  Â  Â  Â  Â  Â  const myOriginalX = myOriginalPos[i3];
Â  Â  Â  Â  Â  Â  Â  const myOriginalY = myOriginalPos[i3 + 1];
Â  Â  Â  Â  Â  Â  Â  const myOriginalZ = myOriginalPos[i3 + 2];

Â  Â  Â  Â  Â  Â  Â  // Convert to spherical coordinates
Â  Â  Â  Â  Â  Â  Â  const myRadius = Math.sqrt(myOriginalX * myOriginalX + myOriginalY * myOriginalY + myOriginalZ * myOriginalZ);
Â  Â  Â  Â  Â  Â  Â  const myTheta = Math.atan2(Math.sqrt(myOriginalX * myOriginalX + myOriginalY * myOriginalY), myOriginalZ); // Pole angle
Â  Â  Â  Â  Â  Â  Â  const myPhi = Math.atan2(myOriginalY, myOriginalX); // Azimuthal angle

Â  Â  Â  Â  Â  Â  Â  // Wave calculations (Amplitudes are controlled by the global variables)
Â  Â  Â  Â  Â  Â  Â  const myPerturbation1 = wave1_amplitude * Math.sin(myTheta * wave1_freq_theta + myPhi * wave1_freq_phi + myTime * wave1_speed);
Â  Â  Â  Â  Â  Â  Â  const myPerturbation2 = wave2_amplitude * Math.cos(myTheta * wave2_freq_theta + myPhi * wave2_freq_phi - myTime * wave2_speed);
Â  Â  Â  Â  Â  Â  Â  const myPerturbation3 = wave3_amplitude * Math.sin(myTheta * wave3_freq_theta + myPhi * wave3_freq_phi + myTime * wave3_speed);

Â  Â  Â  Â  Â  Â  Â  const myTotalPerturbation = myPerturbation1 + myPerturbation2 + myPerturbation3;

Â  Â  Â  Â  Â  Â  Â  // Normalize original position vector (get unit normal)
Â  Â  Â  Â  Â  Â  Â  const myNormalX = myOriginalX / myRadius;
Â  Â  Â  Â  Â  Â  Â  const myNormalY = myOriginalY / myRadius;
Â  Â  Â  Â  Â  Â  Â  const myNormalZ = myOriginalZ / myRadius;

Â  Â  Â  Â  Â  Â  Â  // Move the point along its normal vector by the perturbation amount
Â  Â  Â  Â  Â  Â  Â  myPositionAttribute.array[i3] = myOriginalX + myNormalX * myTotalPerturbation;
Â  Â  Â  Â  Â  Â  Â  myPositionAttribute.array[i3 + 1] = myOriginalY + myNormalY * myTotalPerturbation;
Â  Â  Â  Â  Â  Â  Â  myPositionAttribute.array[i3 + 2] = myOriginalZ + myNormalZ * myTotalPerturbation;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  myPositionAttribute.needsUpdate = true;
Â  Â  Â  Â  Â  myGeometry.computeVertexNormals();
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  // --- UI Update Functions ---
Â  Â  Â  function mySetAutoRotate(myChecked) { controls.autoRotate = myChecked; }

Â  Â  Â  // NEW: Point Size Update
Â  Â  Â  function myUpdatePointSize(myEvent) {
Â  Â  Â  Â  Â  const myNewSize = parseFloat(myEvent.target.value);
Â  Â  Â  Â  Â  document.getElementById('my-point-size-value').textContent = myNewSize.toFixed(1);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (myPointCloud && myPointCloud.material) {
Â  Â  Â  Â  Â  Â  Â  myPointCloud.material.size = myNewSize;
Â  Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // Wave 1 Updates
Â  Â  Â  function myUpdateWave1Amplitude(myEvent) { wave1_amplitude = parseFloat(myEvent.target.value); document.getElementById('wave1-amplitude-value').textContent = wave1_amplitude.toFixed(1); }
Â  Â  Â  function myUpdateWave1FreqTheta(myEvent) { wave1_freq_theta = parseFloat(myEvent.target.value); document.getElementById('wave1-freq-theta-value').textContent = wave1_freq_theta.toFixed(1); }
Â  Â  Â  function myUpdateWave1FreqPhi(myEvent) { wave1_freq_phi = parseFloat(myEvent.target.value); document.getElementById('wave1-freq-phi-value').textContent = wave1_freq_phi.toFixed(1); }
Â  Â  Â  function myUpdateWave1Speed(myEvent) { wave1_speed = parseFloat(myEvent.target.value); document.getElementById('wave1-speed-value').textContent = wave1_speed.toFixed(2); }

Â  Â  Â  // Wave 2 Updates
Â  Â  Â  function myUpdateWave2Amplitude(myEvent) { wave2_amplitude = parseFloat(myEvent.target.value); document.getElementById('wave2-amplitude-value').textContent = wave2_amplitude.toFixed(1); }
Â  Â  Â  function myUpdateWave2FreqTheta(myEvent) { wave2_freq_theta = parseFloat(myEvent.target.value); document.getElementById('wave2-freq-theta-value').textContent = wave2_freq_theta.toFixed(1); }
Â  Â  Â  function myUpdateWave2FreqPhi(myEvent) { wave2_freq_phi = parseFloat(myEvent.target.value); document.getElementById('wave2-freq-phi-value').textContent = wave2_freq_phi.toFixed(1); }
Â  Â  Â  function myUpdateWave2Speed(myEvent) { wave2_speed = parseFloat(myEvent.target.value); document.getElementById('wave2-speed-value').textContent = wave2_speed.toFixed(2); }

Â  Â  Â  // Wave 3 Updates
Â  Â  Â  function myUpdateWave3Amplitude(myEvent) { wave3_amplitude = parseFloat(myEvent.target.value); document.getElementById('wave3-amplitude-value').textContent = wave3_amplitude.toFixed(1); }
Â  Â  Â  function myUpdateWave3FreqTheta(myEvent) { wave3_freq_theta = parseFloat(myEvent.target.value); document.getElementById('wave3-freq-theta-value').textContent = wave3_freq_theta.toFixed(1); }
Â  Â  Â  function myUpdateWave3FreqPhi(myEvent) { wave3_freq_phi = parseFloat(myEvent.target.value); document.getElementById('wave3-freq-phi-value').textContent = wave3_freq_phi.toFixed(1); }
Â  Â  Â  function myUpdateWave3Speed(myEvent) { wave3_speed = parseFloat(myEvent.target.value); document.getElementById('wave3-speed-value').textContent = wave3_speed.toFixed(2); }
Â  Â  Â  
Â  Â  Â  // NEW: Reset Perturbations
Â  Â  Â  function myResetPerturbations() {
Â  Â  Â  Â  Â  // 1. Set global variables to zero
Â  Â  Â  Â  Â  wave1_amplitude = 0.0;
Â  Â  Â  Â  Â  wave2_amplitude = 0.0;
Â  Â  Â  Â  Â  wave3_amplitude = 0.0;

Â  Â  Â  Â  Â  // 2. Update all UI elements to reflect the change
Â  Â  Â  Â  Â  document.getElementById('wave1-amplitude-slider').value = 0;
Â  Â  Â  Â  Â  document.getElementById('wave1-amplitude-value').textContent = '0.0';

Â  Â  Â  Â  Â  document.getElementById('wave2-amplitude-slider').value = 0;
Â  Â  Â  Â  Â  document.getElementById('wave2-amplitude-value').textContent = '0.0';

Â  Â  Â  Â  Â  document.getElementById('wave3-amplitude-slider').value = 0;
Â  Â  Â  Â  Â  document.getElementById('wave3-amplitude-value').textContent = '0.0';
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  myStatusMessage.textContent = 'All wave amplitudes reset to zero (Original Shape shown).';
Â  Â  Â  }

Â  Â  Â  // Resolution Change
Â  Â  Â  function myHandleResolutionChange(myEvent) {
Â  Â  Â  Â  Â  const myValue = parseInt(myEvent.target.value);
Â  Â  Â  Â  Â  if (myValue === 0) myCurrentSegments = segments.low;
Â  Â  Â  Â  Â  else if (myValue === 1) myCurrentSegments = segments.medium;
Â  Â  Â  Â  Â  else if (myValue === 2) myCurrentSegments = segments.high;
Â  Â  Â  Â  Â  myCreatePointCloud(myCurrentSegments.width, myCurrentSegments.height);
Â  Â  Â  }

Â  Â  Â  // --- NEW IMPORT/EXPORT LOGIC ---
Â  Â  Â  
Â  Â  Â  /**
Â  Â  Â  Â * Exports the current point cloud to a GLB/glTF file.
Â  Â  Â  Â */
Â  Â  Â  function myExportPointCloud() {
Â  Â  Â  Â  Â  if (!myPointCloud) {
Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = 'Error: No Point Cloud to export.';
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const myExporter = new THREE.GLTFExporter();

Â  Â  Â  Â  Â  // Options: binary (glb) = true
Â  Â  Â  Â  Â  myExporter.parse(
Â  Â  Â  Â  Â  Â  Â  myPointCloud,
Â  Â  Â  Â  Â  Â  Â  function (myGltf) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Trigger file download
Â  Â  Â  Â  Â  Â  Â  Â  Â  const myBlob = new Blob([myGltf], { type: 'application/octet-stream' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  const myUrl = URL.createObjectURL(myBlob);
Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  const myLink = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  Â  myLink.href = myUrl;
Â  Â  Â  Â  Â  Â  Â  Â  Â  myLink.download = `pointcloud_deformed_${Date.now()}.glb`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(myLink);
Â  Â  Â  Â  Â  Â  Â  Â  Â  myLink.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(myLink);
Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = `Point Cloud exported to .glb successfully!`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(myUrl);
Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  { binary: true } // Export as GLB
Â  Â  Â  Â  Â  );
Â  Â  Â  }

Â  Â  Â  /**
Â  Â  Â  Â * Loads a GLB/glTF file, extracts the mesh geometry, and replaces the current
Â  Â  Â  Â * point cloud with points from the loaded mesh vertices. (Uses async/await)
Â  Â  Â  Â */
Â  Â  Â  async function myLoadFromGltfFile(myEvent) {
Â  Â  Â  Â  Â  const myFile = myEvent.target.files[0];
Â  Â  Â  Â  Â  if (!myFile) return;

Â  Â  Â  Â  Â  myStatusMessage.textContent = `Loading .glb mesh: ${myFile.name}...`;

Â  Â  Â  Â  Â  const myLoader = new THREE.GLTFLoader();
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  // Get the file path
Â  Â  Â  Â  Â  Â  Â  const myFilePath = URL.createObjectURL(myFile);
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // Load the GLTF/GLB asynchronously
Â  Â  Â  Â  Â  Â  Â  const myGltf = await new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  myLoader.load(myFilePath, resolve, undefined, reject);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // 1. Extract and combine all mesh geometries from the scene
Â  Â  Â  Â  Â  Â  Â  const myGeometries = [];
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  myGltf.scene.traverse((myChild) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (myChild.isMesh) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ensure geometry has position data
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (myChild.geometry.isBufferGeometry) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If indexed, de-index it to get unique vertices for the point cloud
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let myGeo = myChild.geometry;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (myGeo.index !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myGeo = myGeo.clone().toNonIndexed();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myGeometries.push(myGeo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  if (myGeometries.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = 'Error: No valid mesh geometry found in the file.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(myFilePath);
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // 2. Merge geometries into a single BufferGeometry
Â  Â  Â  Â  Â  Â  Â  const myMergedGeometry = THREE.BufferGeometryUtils.mergeBufferGeometries(myGeometries);
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // 3. Dispose of old objects and create new Point Cloud
Â  Â  Â  Â  Â  Â  Â  if (mySphereMesh) { scene.remove(mySphereMesh); mySphereMesh.geometry.dispose(); }
Â  Â  Â  Â  Â  Â  Â  if (myPointCloud) { scene.remove(myPointCloud); myPointCloud.geometry.dispose(); }

Â  Â  Â  Â  Â  Â  Â  // Create a simple white color attribute for the new geometry
Â  Â  Â  Â  Â  Â  Â  const myVertexCount = myMergedGeometry.attributes.position.count;
Â  Â  Â  Â  Â  Â  Â  const myColorArray = new Float32Array(myVertexCount * 3).fill(1.0);
Â  Â  Â  Â  Â  Â  Â  myMergedGeometry.setAttribute('color', new THREE.BufferAttribute(myColorArray, 3));

Â  Â  Â  Â  Â  Â  Â  // Create new Point Cloud
Â  Â  Â  Â  Â  Â  Â  const myPointsMaterial = new THREE.PointsMaterial({ vertexColors: true, size: 2, sizeAttenuation: true });
Â  Â  Â  Â  Â  Â  Â  myPointCloud = new THREE.Points(myMergedGeometry, myPointsMaterial);
Â  Â  Â  Â  Â  Â  Â  scene.add(myPointCloud);

Â  Â  Â  Â  Â  Â  Â  // 4. Store original positions (which are the loaded mesh positions)
Â  Â  Â  Â  Â  Â  Â  myOriginalPositions = myMergedGeometry.attributes.position.array.slice(); // Use slice() to copy the array
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = `Loaded mesh as Point Cloud with ${myVertexCount} vertices.`;
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // Re-center the camera controls on the new object (optional but good practice)
Â  Â  Â  Â  Â  Â  Â  controls.target.set(0, 0, 0); 
Â  Â  Â  Â  Â  Â  Â  controls.update();
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // Clear file input
Â  Â  Â  Â  Â  Â  Â  myEvent.target.value = '';
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  } catch (myError) {
Â  Â  Â  Â  Â  Â  Â  myStatusMessage.textContent = `Error loading GLB/GLTF: ${myError.message}`;
Â  Â  Â  Â  Â  Â  Â  console.error(myError);
Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  // Clean up the URL object
Â  Â  Â  Â  Â  Â  Â  if (myFilePath) URL.revokeObjectURL(myFilePath);
Â  Â  Â  Â  Â  }
Â  Â  Â  }

    // Start the application
    window.onload = function() {
        myInitializeSliderValues(); // ðŸ‘ˆ CALL THIS FIRST
        myInit(); 
    };
Â  Â  </script>
Â  </body>
</html>
